name: Release Pull request CI

on:
  pull_request:
    types: [reopened, opened, synchronize, ready_for_review]
    branches: [main]

jobs:
  check-title:
    name: ğŸ“ Check PR title format
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ‘¯â€â™‚ï¸ Clone repository
        uses: actions/checkout@v4
      - name: ğŸ” Validate PR title and version
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          PATTERN="^release: v([0-9]+\.[0-9]+\.[0-9]+) â€” .+ \([0-9]{4}-[0-9]{2}-[0-9]{2}\)$"

          if [[ $TITLE =~ $PATTERN ]]; then
            echo "âœ… PR title format is correct: $TITLE"
            PR_VERSION="${BASH_REMATCH[1]}"
            echo "PR version extracted: $PR_VERSION"
            
            PACKAGE_VERSION=$(jq -r '.version' package.json)
            echo "Package.json version: $PACKAGE_VERSION"
            
            if [[ "$PR_VERSION" == "$PACKAGE_VERSION" ]]; then
              echo "âœ… Version in PR title matches package.json"
            else
              echo "âŒ Version mismatch!"
              echo "PR title version: $PR_VERSION"
              echo "package.json version: $PACKAGE_VERSION"
              exit 1
            fi
          else
            echo "âŒ PR title format is incorrect"
            echo "Expected format: release: vX.Y.Z â€” Description (YYYY-MM-DD)"
            echo "Current title: $TITLE"
            exit 1
          fi

  check-version:
    name: ğŸ” Check version
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ‘¯â€â™‚ï¸ Clone repository
        uses: actions/checkout@v4
      - name: ğŸ”§ Use Node.js 24.x
        uses: actions/setup-node@v5
        with:
          node-version: 24.x
      - name: ğŸ” Enable Corepack
        run: corepack enable
        shell: bash
      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
      - name: ğŸ“‹ Check version increment
        id: check-version
        run: |
          CURRENT_VERSION=$(jq -r '.version' package.json)
          MAIN_VERSION=$(git show origin/main:package.json | jq -r '.version')
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "MAIN_VERSION=$MAIN_VERSION" >> $GITHUB_ENV
          if [[ "$CURRENT_VERSION" == "$MAIN_VERSION" ]]; then
            echo "Version has not been incremented."
            exit 1
          else
            echo "Version has been incremented."
          fi
      - name: ğŸ—’ï¸ Version check report
        if: always()
        run: |
          if [[ ${{ steps.check-version.outcome }} == "success" ]]; then
            echo "Current version: $CURRENT_VERSION"  
            echo "âœ… Version has been incremented"
          else
            echo "Main version: $MAIN_VERSION"
            echo "âŒ Version must be incremented"
          fi

  build-test:
    name: ğŸ—ï¸ Build on Node.js 24.x
    runs-on: ubuntu-latest
    needs: [check-title, check-version]

    steps:
      - name: ğŸ‘¯â€â™‚ï¸ Clone repository
        uses: actions/checkout@v4
      - name: ğŸ”§ Use Node.js 24.x
        uses: actions/setup-node@v5
        with:
          node-version: 24.x
      - name: ğŸ” Enable Corepack
        run: corepack enable
        shell: bash
      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
      - name: ğŸ§° Build
        id: build-test
        run: pnpm build
      - name: ğŸ—’ï¸ Build report
        if: always()
        run: |
          echo "Node.js version: $(node -v)"
          if [[ ${{ steps.build-test.outcome }} == "success" ]]; then
            echo "âœ… Build succeeded"
          else
            echo "âŒ Build failed"
          fi

  conclusion:
    name: ğŸ Conclusion
    runs-on: ubuntu-latest
    needs: [build-test]

    steps:
      - name: ğŸ—’ï¸ Final report
        run: |
          if [[ ${{ needs.build-test.result }} == "success" ]]; then
            echo "âœ… All checks passed. Ready for release."
          else
            echo "âŒ Some checks failed. Please fix the issues before merging."
          fi
